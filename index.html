<html>
<head>
    <meta charset="utf-8">
    <title>Weather</title>
    <!-- Sets initial viewport load and disables zooming  -->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="resc/css/ionic.css">
    <link rel="stylesheet" href="resc/spinner/waitMe.min.css">
    <script type="text/javascript" src="resc/js/jquery.min.js"></script>
    <script type="text/javascript" src="resc/spinner/waitMe.min.js"></script>
    <script type="text/javascript" src="resc/js/html5sql.js"></script>
    <script src="phonegap.js" type="text/javascript"></script>
    <script type="text/javascript">


        var pictureSource; // picture source
        var destinationType; // sets the format of returned value
        var pageNumber = 1;

        var dbName = 'com.amc.documents.database';
        var dbDescription = 'Amc Documents Database.';
        var dbSize = (5 * 1024 * 1024);

        document.addEventListener("deviceready", onDeviceReady, false);

        function onDeviceReady() {

            pictureSource = navigator.camera.PictureSourceType;
            destinationType = navigator.camera.DestinationType;

            html5sql.openDatabase(dbName, dbDescription, dbSize);

            html5sql.process(
                 [
                     "CREATE TABLE IF NOT EXISTS DealersEnteries (EnteryId INTEGER PRIMARY KEY AUTOINCREMENT, EnteryName, CreationDate,BillingDate,BillingAmt);",
                     "CREATE TABLE IF NOT EXISTS DealersDocs (DocId INTEGER PRIMARY KEY AUTOINCREMENT, EnteryId , DocTitle, DocName, CreationDate);"
                 ],
                 function () {
                     showMessage('Your application is ready!');
                 },
                 function (error, statement) {
                     showMessage("Error: " + error.message + " when processing " + statement);
                 }
             );
        }

        function onCaptureClick() {
            navigator.camera.getPicture(
            function (imageData) {
                var imageHtml = '<div class="list card" style="margin: 0; padding: 0;" id="itemNo' + pageNumber + '"><div class="item">';
                imageHtml += '<h2>Documents Page - ' + pageNumber + '</h2></div>';
                imageHtml += '<div class="item item-image">';
                imageHtml += '<img src="' + imageData + '" title="Documents Page - ' + pageNumber + '" style="padding:10px;" class="docPicture"/>';
                imageHtml += '</div>';
                imageHtml += '<a class="item item-icon-left assertive icon ion-remove" style="text-align:left;" href="#" onclick="removeDoc(' + pageNumber + ');">Remove Page - ' + pageNumber + '</a>';
                imageHtml += '</div>';
                $("#imageCards").append(imageHtml);
                $("#btnSaveDocuments").css("display", "block");
                $("#btnCapture").text("Capture More Images");
                pageNumber = pageNumber + 1;
            },
            function (message) {
                showMessage('Failed because: ' + message);
            },
            {
                quality: 50
            });

            return false;
        }

        function removeDoc(elem) {
            $("#itemNo" + elem).remove();
            return false;
        }

        function onSaveDocumentsClick() {
            try {
                var insertScript = [];
                var strCommand = '';

                $(".ionic-body").waitMe({
                    effect: 'ios',
                    text: 'Please wait',
                    bg: 'rgba(255,255,255,0.7)',
                    color: '#000'
                });

                html5sql.openDatabase(dbName, dbDescription, dbSize);

                strCommand = "INSERT INTO DealersEnteries (EnteryName, CreationDate,BillingDate,BillingAmt) VALUES('" + $("#txtDealer").val() + "','" + getCurrentDateAndTime() + "','" + ($("#txtBillDate").val() + getCurrentTime()) + "','" + $("txtBillAmt").val() + "');";

                showMessage(strCommand);

                html5sql.process(
                [strCommand],
                function (transaction, results, rowsArray) {

                    $(".docPicture").each(function () {
                        var docTitle = $(this).attr("title");
                        var docSrc = $(this).attr("src");
                        insertScript.push("INSERT INTO DealersDocs (EnteryId , DocTitle, DocName, CreationDate) VALUES(" + results.insertId + ",'" + docTitle + "','" + docSrc + "','" + getCurrentDateAndTime() + "');");
                    });

                    showMessage(insertScript);

                    html5sql.process(
                    insertScript,
                    function (transactionInner, resultsInner, rowsArrayInner) {
                        showMessage('Document has bee saved successfully, click View Document ( menu at bottom ) to view stored documents');
                        $('.ionic-body').waitMe('hide');
                    },
                    function (message) {
                        showMessage('Failed to save document images because, ' + message);
                        $('.ionic-body').waitMe('hide');
                    });
                },
                function (message) {
                    showMessage('Failed to save document because, ' + message);
                    $('.ionic-body').waitMe('hide');
                });
            } catch (e) {
                showMessage('Failed to store information because, ' + e);
                $('.ionic-body').waitMe('hide');
            }
        }

        function showMessage(error) {
            navigator.notification.alert(
                            error,
                            function () { },
                            'AMC Documents',
                            'Ok'
                        );
        }

        function getCurrentDateAndTime() {
            var currentdate = new Date();
            var datetime = currentdate.getFullYear() + "/"
                + (currentdate.getMonth() + 1) + "/"
                + currentdate.getDate() + " @ "
                + currentdate.getHours() + ":"
                + currentdate.getMinutes() + ":"
                + currentdate.getSeconds();

            return datetime;
        }

        function getCurrentTime() {
            var currentdate = new Date();
            var datetime = " @ "
                + currentdate.getHours() + ":"
                + currentdate.getMinutes() + ":"
                + currentdate.getSeconds();

            return datetime;
        }
    </script>
</head>
<body>
    <div class="ionic-body">
        <div class="bar bar-header bar-positive">
            <a class="button icon ion-home" href="index.html"></a>
            <h1 class="title">
                &nbsp;&nbsp;AMC Documents</h1>
            <a class="button icon ion-help" href="help.html"></a>
        </div>
        <div class="content has-header has-footer padding" style="overflow: scroll; height: 100%;"
            id="container">
            <div id="dvDealers" style="width: 100%;">
                <div class="list">
                    <label class="item">
                        <b>Dealers Bill Information</b>
                    </label>
                    <label class="item item-input icon ion-android-social-user">
                        &nbsp;&nbsp;
                        <input type="text" id="txtDealer" placeholder="Please enter dealer name" style="border: solid 1px #ddd;
                            margin: 5px; padding: 5px;">
                    </label>
                    <label class="item item-input icon ion-android-calendar">
                        &nbsp;&nbsp;
                        <input type="date" id="txtBillDate" placeholder="Please select bill date" style="border: solid 1px #ddd;
                            margin: 5px; padding: 5px;">
                    </label>
                    <label class="item item-input icon ion-pricetag">
                        &nbsp;&nbsp;
                        <input type="number" id="txtBillAmt" placeholder="Please select bill amount" style="border: solid 1px #ddd;
                            margin: 5px; padding: 5px;">
                    </label>
                </div>
            </div>
            <div style="width: 100%;" id="imageCards">
            </div>
            <div style="width: 100%;">
                <br />
                <br />
                <a id="btnCapture" class="button button-full button-assertive icon icon-left ion-ios7-camera"
                    onclick="onCaptureClick();">Capture Image</a>
                <br />
                <a id="btnSaveDocuments" style="display: none;" class="button button-full button-stable icon icon-left ion-document"
                    onclick="onSaveDocumentsClick();">Save Document</a>
                <br />
                <br />
                <br />
            </div>
        </div>
        <div class="tabs tabs-positive tabs-icon-top">
            <a class="tab-item" href="index.html"><i class="icon ion-home" style="font-size: 25px;">
            </i>Home</a> <a class="tab-item" href="index.html"><i class="icon ion-ios7-information"
                style="font-size: 25px;"></i>Add Document</a> <a class="tab-item" href="view.html"><i
                    class="icon ion-ios7-bookmarks" style="font-size: 25px;"></i>View Documents</a>
        </div>
    </div>
</body>
</html>
